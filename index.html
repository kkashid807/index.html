<script>
const status = document.getElementById("status");
const userText = document.getElementById("userText");
const jarvisText = document.getElementById("jarvisText");

let listening = false;

/* ========== SPEECH ENGINE ========== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onstart = () => status.innerText = "Jarvis listening... üéß";
    recognition.onend = () => {
        if (listening) recognition.start();
        else status.innerText = "Tap the button and speak...";
    };

    recognition.onresult = (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
        userText.innerText = transcript;
        processCommand(transcript);
    };
}

/* ========== CONTROL BUTTON ========== */
function startListening() {
    if (!SpeechRecognition) {
        alert("Use Chrome browser on mobile");
        return;
    }

    listening = !listening;

    if (listening) {
        recognition.start();
    } else {
        recognition.stop();
    }
}

/* ========== SPEAK FUNCTION ========== */
function speak(text) {
    const speech = new SpeechSynthesisUtterance(text);
    speech.rate = 1;
    window.speechSynthesis.speak(speech);
}

/* ========== COMMAND PROCESSOR ========== */
function processCommand(command) {
    let response = "Sorry KK, I didn't understand.";

    /* GREETING */
    if (command.match(/\b(hello|hi|hey)\b/)) {
        response = "Hello KK. Jarvis ready.";
    }

    /* TIME + DATE */
    else if (command.includes("time")) {
        response = "The time is " + new Date().toLocaleTimeString();
    }

    else if (command.includes("date")) {
        response = "Today is " + new Date().toDateString();
    }

    /* OPEN WEBSITES */
    else if (command.includes("open youtube")) {
        response = "Opening YouTube";
        window.open("https://www.youtube.com", "_blank");
    }

    else if (command.includes("open google")) {
        response = "Opening Google";
        window.open("https://www.google.com", "_blank");
    }

    /* SEARCH ANYTHING */
    else if (command.startsWith("search")) {
        const query = command.replace("search", "").trim();
        response = "Searching for " + query;
        window.open("https://www.google.com/search?q=" + encodeURIComponent(query), "_blank");
    }

    /* PLAY SONG */
    else if (command.startsWith("play")) {
        const song = command.replace("play", "").trim();
        response = "Playing " + song;
        window.open("https://www.youtube.com/results?search_query=" + encodeURIComponent(song), "_blank");
    }

    /* CALL NUMBER (mobile only) */
    else if (command.startsWith("call")) {
        const number = command.replace("call", "").trim();
        response = "Calling " + number;
        window.location.href = "tel:" + number;
    }

    /* WEATHER */
    else if (command.includes("weather")) {
        response = "Showing weather report";
        window.open("https://www.google.com/search?q=weather", "_blank");
    }

    /* CALCULATOR */
    else if (command.includes("calculator")) {
        response = "Opening calculator";
        window.open("https://www.google.com/search?q=calculator", "_blank");
    }

    /* SET ALARM */
    else if (command.includes("set alarm")) {
        const timeMatch = command.match(/(\d+)\s*(am|pm)?/);

        if (timeMatch) {
            let hour = parseInt(timeMatch[1]);
            const period = timeMatch[2];

            if (period === "pm" && hour < 12) hour += 12;
            if (period === "am" && hour === 12) hour = 0;

            const now = new Date();
            const alarmTime = new Date();
            alarmTime.setHours(hour, 0, 0, 0);

            if (alarmTime < now) alarmTime.setDate(alarmTime.getDate() + 1);

            const timeout = alarmTime - now;

            setTimeout(() => {
                speak("Wake up KK. Alarm ringing.");
                alert("‚è∞ Alarm!");
            }, timeout);

            response = "Alarm set for " + hour + ":00";
        } else {
            response = "Please say a valid time.";
        }
    }

    /* IDENTITY */
    else if (command.includes("who are you")) {
        response = "I am Jarvis, your AI mobile assistant.";
    }

    jarvisText.innerText = response;
    speak(response);
}
</script>
